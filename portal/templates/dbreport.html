<HTML>
    <HEAD>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <!-- https://developers.google.com/chart/interactive/docs/gallery/linechart -->
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

        <style>
            /* Table */

            table {
                border-collapse: collapse;
            }
            th, td {
                border: 1px solid darkgreen;
                padding: 10px;
                text-align: left;
            }
            th {
                background-color:darkgreen;
                color:white;
            }
            tr:nth-child(even) {
                background-color: #eee;
            }
            tr:nth-child(odd) {
                background-color: #fff;
            }

            /* Button  */
            button {
                background-color: darkgreen; /* Green */
                border: none;
                color: white;
                padding: 8px 16px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
            }

            /* Drop downs */

            select {
                width: 20%;
                padding: 8px 10px;
                border: none;
                border-radius: 6px;
                background-color: darkgreen;
                color: white;
                font-size: 14px;
            }


            /* Input text */

            input[type=submit]:hover {
                background-color: #45a049;
            }

            div {
                border-radius: 5px;
                background-color: #f2f2f2;
                padding: 10px;
            }


            .a {
                padding: 5px;
                text-align: center;
            }

            /* TOP MENU */
            body {margin:0;}

            .navbar {
                overflow: hidden;
                background-color: #333;
                position: fixed;
                top: 0;
                width: 100%;
            }

            .navbar a {
                float: left;
                display: block;
                color: #f2f2f2;
                text-align: center;
                padding: 8px 8px;
                text-decoration: none;
                font-size: 16px;
            }

            /*.navbar a:hover {*/
            /*    background: green;*/
            /*    color: white;*/
            /*}*/

            .navbar input {
                float: left;
                display: block;
                color: darkgreen;
                text-align: center;
                vertical-align: center;
                padding: 6px 6px;
                text-decoration: none;
                font-size: 14px;
            }

            .navbar button{
                float: left;
                display: block;
                color: white;
                text-align: center;
                vertical-align: center;
                margin-left: 6px;
                text-decoration: none;
                font-size: 14px;
                margin-top: 2px;
                margin-left: 2%;
            }


            .navbar select{
                float: left;
                display: block;
                color: white;
                text-align: center;
                vertical-align: center;
                margin-left: 6px;
                text-decoration: none;
                font-size: 14px;
                width: 15%;
                min-width: 120px;
                margin-top: 1px;
                margin-bottom: 1px;
            }


            .main {
                padding: 16px;
                margin-top: 30px;
                height: 1500px;
            }


            /* ---  */
            .tableGraph {
                padding: 0px;
                padding-top: 0px;
            }

        </style>
    </HEAD>
    <BODY onload="init()">


        <!-- *****************************************************************-->
        <!-- **********************     MENU    ******************************-->
        <!-- *****************************************************************-->
        <div class="navbar" style="z-index: 1000;">
            <a>Build # (date): </a>
            <select id="filter_date_dd" onchange="updateMetricAndTarget()"></select>

            <a>Scenario: </a>
            <select id="filter_scenario_dd"></select>

            <a>Metric: </a>
            <select id="filter_metric_dd"></select>

            <a>Target: </a>
            <select id="filter_target_dd"></select>

            <button type="button" onclick="getData('#excelDataTable', 'rest_results')">Generate</button>


            <button type="button" onclick="generateAllGraphs()">Graph Test</button>

        </div>
        <!-- *****************************************************************-->
        <!-- *****************      MAIN PAGE        *************************-->
        <!-- *****************************************************************-->
        <div class="main">
            <H1>REPORT RESULTS</H1>



            <table id="excelDataTable"></table>

            <table id="tableGraph" class="columns" border="0" cellspacing="0" cellpadding="0">
<!--                <tr>-->
<!--                    <th>Graph A</th>-->
<!--                    <th>Graph B</th>-->
<!--                </tr>-->
<!--                <tr>-->
<!--                    <td class="tableGraph"><div id="curve_chart1" style="border: 1px solid #ccc"></div></td>-->
<!--                    <td class="tableGraph"><div id="curve_chart2" style="border: 1px solid #ccc"></div></td>-->
<!--                </tr>-->
            </table>




<!--            <table class="columns" border="0" cellspacing="0" cellpadding="0">-->
<!--                <tr>-->
<!--                    <th>Graph A</th>-->
<!--                    <th>Graph B</th>-->
<!--                </tr>-->
<!--                <tr>-->
<!--                    <td class="tableGraph"><div id="curve_chart3" style="border: 1px solid #ccc"></div></td>-->
<!--                    <td class="tableGraph"><div id="curve_chart4" style="border: 1px solid #ccc"></div></td>-->
<!--                </tr>-->
<!--            </table>-->


        </div>

    </BODY>
    <SCRIPT>
        var rest_request = new XMLHttpRequest()
        var rest_results = null;




        function getDataFromServer(serverVerb){
         // Open a new connection, using the GET request on the URL endpoint
            rest_request.open('GET', serverVerb, false);

            // Send request
            rest_request.send();
        }


        // Nested function to process received results
        rest_request.onload = function () {
            var response = rest_request.responseText;
            console.log("ok"+ response);
            var result = JSON.parse(response);
            rest_results = result.return;
        }

        function init()
        {
            init_build_number_list();
            updateMetricAndTarget();
        }

        /////////////////////////////////////////////////////////////////
        //
        // Update the scenario, metric and taget based on the selected
        // build number
        //
        function updateMetricAndTarget(){
            init_filter_list(document.getElementById("filter_scenario_dd"), "scenario_by_build_number", "scenario");
            init_filter_list(document.getElementById("filter_metric_dd"), "metrics_by_build_number", "metric_name");
            init_filter_list(document.getElementById("filter_target_dd"), "target_by_build_number", "target");
        }

        /////////////////////////////////////////////////////////////////
        //
        // Initialize the list of Build number (and date) from the
        // database.
        //
        function init_build_number_list(){
            var filter_dd_build = document.getElementById("filter_date_dd");

            var verb = getRestURL("testruns_get_all_dates");
            getDataFromServer(verb);

            for (var i = 0; i < rest_results.length; i++) {
                var option = document.createElement("option");
                option.value = rest_results[i].build_number;
                option.text = rest_results[i].build_number +  " (" +  rest_results[i].run_time + ")";
                filter_dd_build.appendChild(option);
            }
        }

        /////////////////////////////////////////////////////////////////
        //
        // Initialize the list of filters based on the selected build
        // number. This includes Scenario, Metric and Target
        //
        function init_filter_list(filter_dd, restId, value){


            // Get selected build number
            var filter_dd_build = document.getElementById("filter_date_dd");
            var build_number = filter_dd_build.options[filter_dd_build.selectedIndex].value

            var verb = getRestURL(restId);
            verb = verb.replace("<<BUILD_NUMBER>>", build_number);
            getDataFromServer(verb);

            filter_dd.innerHTML = "";

            if(rest_results.length > 0){
                var option = document.createElement("option");
                option.value = "ANY";
                option.text = "ANY";
                filter_dd.appendChild(option);
            }

            //Create and append the options
            for (var i = 0; i < rest_results.length; i++) {
                var option = document.createElement("option");
                option.value = rest_results[i][value] + i;
                option.text = rest_results[i][value];
                filter_dd.appendChild(option);
            }
        }



        /////////////////////////////////////////////////////////////////
        //
        // Generate the grpah based on the filters
        //
        //
        function generateAllGraphs(){
            // Get selected build number
            var filter_dd_build = document.getElementById("filter_date_dd");
            var build_number = filter_dd_build.options[filter_dd_build.selectedIndex].value
            var scenarios = document.getElementById("filter_scenario_dd").options;

            scenarioA = 'gripper';

            var graphPerLine=2;
            var idxGraph = 0, availableGraph = 0;
            var table = document.getElementById("tableGraph");
            table.innerText = "";

            for(var scenario in scenarios){
                if (scenario.outerText != "ANY"){
                    if (idxGraph >= availableGraph){
                        // Find a <table> element with id="myTable":
                        var row = table.insertRow(Math.floor(idxGraph/graphPerLine));
                        row.className = "tableGraph";

                        for(var i = 0; i < graphPerLine; i++){
                            // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
                            var cell = row.insertCell(i);
                            cell.id = "genGraph" + availableGraph++;


                            
                            // Add some text to the new cells:
                            cell.innerHTML = "NEW CELL1";
                        }
                    }
                    idxGraph++;
                }
            }


            /*\
<!--                <tr>-->
<!--                    <th>Graph A</th>-->
<!--                    <th>Graph B</th>-->
<!--                </tr>-->
<!--                <tr>-->
<!--                    <td class="tableGraph"><div id="curve_chart1" style="border: 1px solid #ccc"></div></td>-->
<!--                    <td class="tableGraph"><div id="curve_chart2" style="border: 1px solid #ccc"></div></td>-->
<!--                </tr>-->
             */

            for(var scenario in scenarios){
                if (scenario.outerHTML != "ANY"){
                    google.charts.load('current', {'packages':['corechart']});

                    var verb = getRestURL("metric_by_build_number_scenario");
                    verb = verb.replace("<<BUILD_NUMBER>>", build_number);
                    verb = verb.replace("<<SCENARIO>>", scenario.outerHTML);
                    getDataFromServer(verb);


                    var idxGraph = 1;
                    for(var key in rest_results){
                        console.log(key);
                        var data = google.visualization.arrayToDataTable(rest_results[key]);

                        var options = {
                            title: 'Resources Performance - CPU',
                            curveType: 'function',
                            legend: { position: 'bottom' },
                            width:600,
                            height:400,
                            chartArea: {'width': '80%', 'height': '86%'},
                        };

                        var chart = new google.visualization.LineChart(document.getElementById('curve_chart' + idxGraph));
                        chart.draw(data, options);
                        idxGraph++;
                    }

                }
            }



        }


        /***
         *
         *  Obtain data and fill a table with that data
         *
         * */
        function getData(anchor, type){
            var verb = getRestURL(type);
            buildHtmlTable(anchor, verb);


        }
        /***
         *
         *  Create the needed URL to call a REST web service
         *
         * */
        function getRestURL(type){
            var verb = "http://127.0.0.1:5280";
            switch(type){
                case "rest_results":
                    verb += "/rest_results/get";

                    verb += createRestParamList(["start_date", "end_date", "build_number", "status", "trigger"]);
                    break;
                case "products":
                    verb += "/products/get";
                    if (prodname = document.getElementById("prodname")){
                        if(ret = prodname.value){
                            verb += "?name=" + ret;
                            if(prodversion = document.getElementById("prodversion")){
                                if(ret = prodversion.value) {
                                    verb += "&version=" + ret;
                                }
                            }
                        }
                    }
                    break;
                case "metrics":
                    verb += "/metrics/get";
                    if (metricname = document.getElementById("metricname")){
                        if(ret = metricname.value){
                            verb += "?name=" + ret;
                            if(metrictarget = document.getElementById("metrictarget")){
                                if(ret = metrictarget.value) {
                                    verb += "&target=" + ret;
                                }
                            }
                        }
                    }
                    break;
                case "metrics_raw":

                    verb += "/metrics/get/by_build_number";
                    verb +=  "?" + "build_number=" + document.getElementById("metBuildNumber").value;
                    verb +=  "&" + "target=" + document.getElementById("metBuildTarget").value;
                    verb +=  "&" + "scenario=" + document.getElementById("metScenario").value;
                    verb +=  "&" + "metric=" + document.getElementById("metMetric").value;

                    break;
                case "testruns_get_all_dates":
                    verb += "/testruns/getAllDates";
                    verb += "?" + "sort=" + "ASC"; // ["DESC" | "ASC"]
                    break;
                case "metrics_by_build_number":
                    verb += "/metrics/get/metric_by_build_number";
                    verb += "?" + "build_number=<<BUILD_NUMBER>>";
                    break;
                case "target_by_build_number":
                    verb += "/metrics/get/target_by_build_number";
                    verb += "?" + "build_number=<<BUILD_NUMBER>>";
                    break;
                case "scenario_by_build_number":
                    verb += "/testruns/scenario_by_build_number";
                    verb += "?" + "build_number=<<BUILD_NUMBER>>";
                    break;
                case "metric_by_build_number_scenario":
                    verb += "/metrics/get/data_graph";
                    verb += "?" + "build_number=<<BUILD_NUMBER>>&scenario=<<SCENARIO>>";
                    break;
                default:
                    verb += "/rest_results/get";
            }
            return verb;
        }

        function createRestParamList(listOfID){
            var paramList = "";
            var bFirst = true;
            for (var i = 0; i < listOfID.length; i++) {
                if(idElem = document.getElementById(listOfID[i])){
                    if(val =  idElem.value){
                        if(val != 'ANY'){
                            paramList += bFirst?"?":"&";
                            bFirst = false;
                            paramList += listOfID[i] + "=" + val;
                        }
                    }
                }
            }
            return paramList;
        }

        /***
         *
         *  Create a table with the passed data tuple
         *
         * */
        function buildHtmlTable(selector, verb) {
            //var rest_results = getData_rest_results();
            getDataFromServer(verb);

            if(!rest_results) return;

            $(selector).empty();

            var columns = addAllColumnHeaders(rest_results, selector);

            for (var i = 0; i < rest_results.length; i++) {
                var row$ = $('<tr/>');
                for (var colIndex = 0; colIndex < columns.length; colIndex++) {
                    var cellValue = rest_results[i][columns[colIndex]];
                    if (cellValue == null) cellValue = "";
                    row$.append($('<td/>').html(cellValue));
                }
                $(selector).append(row$);
            }
        }

        // Adds a header row to the table and returns the set of columns.
        // Need to do union of keys from all records as some records may not contain
        // all records.
        function addAllColumnHeaders(myList, selector) {
            var columnSet = [];
            var headerTr$ = $('<tr/>');

            for (var i = 0; i < myList.length; i++) {
                var rowHash = myList[i];
                for (var key in rowHash) {
                    if ($.inArray(key, columnSet) == -1) {
                        columnSet.push(key);
                        headerTr$.append($('<th/>').html(key));
                    }
                }
            }
            $(selector).append(headerTr$);
            return columnSet;
        }

    </SCRIPT>
</HTML>


